<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Authenticating…</title>
  <script src="https://res.cdn.office.net/teams-js/2.22.0/js/MicrosoftTeams.min.js"></script>
  <script src="https://alcdn.msauth.net/browser/3.27.0/js/msal-browser.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; display: flex; align-items: center;
           justify-content: center; height: 100vh; margin: 0; background: #FAF8F4; }
    .msg { text-align: center; color: #2C2416; }
    .spinner { width: 32px; height: 32px; border: 3px solid #EEE8DF;
               border-top-color: #C8A96E; border-radius: 50%;
               animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
<div class="msg">
  <div class="spinner"></div>
  <div>Signing you in…</div>
</div>
<script>
  const CLIENT_ID = "0c2d3aa6-1e8d-4c4a-a290-9a8590b5597b";
  const TENANT_ID = "24067079-ff6a-4c4e-a5de-7c5ac7ddf4d8";
  const REDIRECT  = "https://mountmeru-rooms.vercel.app/auth-teams.html";
  const SCOPES    = ["Calendars.ReadWrite", "User.Read"];

  (async () => {
    await microsoftTeams.app.initialize();

    const msalApp = new msal.PublicClientApplication({
      auth: {
        clientId: CLIENT_ID,
        authority: `https://login.microsoftonline.com/${TENANT_ID}`,
        redirectUri: REDIRECT,
      },
      cache: { cacheLocation: "sessionStorage" },
    });
    await msalApp.initialize();

    try {
      // If returning from Microsoft login redirect, grab the token and notify Teams
      const result = await msalApp.handleRedirectPromise();
      if (result?.accessToken) {
        microsoftTeams.authentication.notifySuccess(result.accessToken);
        return;
      }

      // First visit — start the login redirect inside this popup window
      await msalApp.loginRedirect({ scopes: SCOPES });
    } catch (e) {
      microsoftTeams.authentication.notifyFailure(e.message || String(e));
    }
  })();
</script>
</body>
</html>
